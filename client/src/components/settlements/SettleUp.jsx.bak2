import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
    ArrowRight, Check, X, DollarSign,
    FileText, Clock, CheckCircle, AlertCircle,
    Send, Trash2, ChevronDown, ChevronUp
} from 'lucide-react';
import { Button } from '../ui/Button';
import { Avatar } from '../ui/Avatar';
import { Badge } from '../ui/Badge';
import { useSettlementStore } from '../../stores/settlementStore';
import { useAuthStore } from '../../stores/authStore';
import { useToast } from '../ui/Toast';
import { useChatStore } from '../../stores/chatStore';
import { formatCurrency, formatDate } from '../../utils/helpers';

export function SettleUp({ groupId, members, isAdmin = false, onClose }) {
    const { user } = useAuthStore();
    const {
        settlements,
        simplifiedDebts,
        detailedDebts,
        fetchSettlements,
        fetchBalances,
        createSettlement,
        confirmSettlement,
        deleteSettlement,
        isLoading,
        isSimplified,
        toggleSimplify
    } = useSettlementStore();
    const toast = useToast();

    const [activeTab, setActiveTab] = useState('debts');
    const [expandedDebt, setExpandedDebt] = useState(null);
    const [paymentAmount, setPaymentAmount] = useState('');
    const [note, setNote] = useState('');
    const [isPartial, setIsPartial] = useState(false);

    useEffect(() => {
        fetchSettlements(groupId);
        // We rely on GroupDetail or Store state for balances to avoid race conditions.
        // But if we want to ensure fresh data on open:
        fetchBalances(groupId);
    }, [groupId]);

    // Payer marks as paid
    const handleMarkAsPaid = async (debt) => {
        const amount = isPartial ? parseFloat(paymentAmount) : debt.amount;

        if (isPartial && (!amount || amount <= 0)) {
            toast.error('Invalid amount', 'Please enter a valid amount');
            return;
        }

        if (amount > debt.amount) {
            toast.error('Amount too high', 'Cannot pay more than owed');
            return;
        }

        const result = await createSettlement(groupId, {
            from: debt.from._id,
            to: debt.to._id,
            amount: amount,
            note: note || (amount < debt.amount ? `Partial: ${formatCurrency(amount)}` : 'Payment sent'),
        });

        if (result.success) {
            toast.success('ðŸ’¸ Payment recorded!', `Awaiting ${debt.to.name}'s confirmation`);
            resetForm();
            fetchBalances(groupId);
            fetchSettlements(groupId);
        } else {
            toast.error('Failed', result.message || 'Please try again');
        }
    };

    // Receiver confirms payment directly (one click for full amount)
    const handleQuickConfirm = async (debt) => {
        const result = await createSettlement(groupId, {
            from: debt.from._id,
            to: debt.to._id,
            amount: debt.amount,
            note: 'Payment confirmed',
        });

        if (result.success) {
            const confirmResult = await confirmSettlement(groupId, result.settlement._id);
            if (confirmResult.success) {
                toast.success('âœ… Payment confirmed!', 'Settlement complete');
                fetchBalances(groupId);
                fetchSettlements(groupId);
            }
        } else {
            toast.error('Failed', result.message || 'Please try again');
        }
    };

    // Receiver confirms with custom amount
    const handleConfirmWithAmount = async (debt) => {
        const amount = parseFloat(paymentAmount);

        if (!amount || amount <= 0) {
            toast.error('Invalid amount', 'Please enter a valid amount');
            return;
        }

        if (amount > debt.amount) {
            toast.error('Amount too high', 'Cannot be more than owed');
            return;
        }

        const result = await createSettlement(groupId, {
            from: debt.from._id,
            to: debt.to._id,
            amount: amount,
            note: note || `Partial: ${formatCurrency(amount)}`,
        });

        if (result.success) {
            const confirmResult = await confirmSettlement(groupId, result.settlement._id);
            if (confirmResult.success) {
                toast.success('âœ… Payment confirmed!', 'Settlement complete');
                resetForm();
                fetchBalances(groupId);
                fetchSettlements(groupId);
            }
        } else {
            toast.error('Failed', result.message || 'Please try again');
        }
    };

    const handleConfirmPending = async (settlementId) => {
        const result = await confirmSettlement(groupId, settlementId);
        if (result.success) {
            toast.success('âœ… Confirmed!', 'Settlement complete');
            fetchBalances(groupId);
            fetchSettlements(groupId);
        } else {
            toast.error('Failed', result.message);
        }
    };

    const handleReject = async (settlementId) => {
        const result = await deleteSettlement(groupId, settlementId);
        if (result.success) {
            toast.info('âŒ Rejected', 'Payer notified');
            fetchBalances(groupId);
            fetchSettlements(groupId);
        } else {
            toast.error('Failed', result.message);
        }
    };

    const resetForm = () => {
        setExpandedDebt(null);
        setPaymentAmount('');
        setNote('');
        setIsPartial(false);
    };

    const toggleExpand = (debtKey) => {
        if (expandedDebt === debtKey) {
            resetForm();
        } else {
            setExpandedDebt(debtKey);
            setPaymentAmount('');
            setNote('');
            setIsPartial(false);
        }
    };

    const myDebts = simplifiedDebts.filter(d => d.from._id === user?._id);
    const owedToMe = simplifiedDebts.filter(d => d.to._id === user?._id);
    const otherDebts = isAdmin ? simplifiedDebts.filter(d =>
        d.from._id !== user?._id && d.to._id !== user?._id
    ) : [];

    const pendingConfirmations = settlements.filter(s =>
        s.to._id === user?._id && !s.confirmedByRecipient
    );

    const myPendingPayments = settlements.filter(s =>
        s.from._id === user?._id && !s.confirmedByRecipient
    );

    return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: '20px' }}>
            {/* Tabs */}
            <div style={{
                display: 'flex',
                gap: '8px',
                backgroundColor: '#f5f5f5',
                padding: '4px',
                borderRadius: '12px'
            }}>
                {[
                    { id: 'debts', label: 'Settle Up' },
                    { id: 'history', label: 'History' },
                ].map(tab => (
                    <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        style={{
                            flex: 1,
                            padding: '12px',
                            borderRadius: '8px',
                            border: 'none',
                            backgroundColor: activeTab === tab.id ? '#fff' : 'transparent',
                            fontWeight: activeTab === tab.id ? '600' : '500',
                            fontSize: '14px',
                            cursor: 'pointer',
                            boxShadow: activeTab === tab.id ? '0 1px 3px rgba(0,0,0,0.1)' : 'none',
                            transition: 'all 0.2s'
                        }}
                    >
                        {tab.label}
                    </button>
                ))}
            </div>
            {/* Simplify Debts Toggle */}
            {activeTab === 'debts' && (
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0 8px' }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <div style={{
                            width: '36px', height: '20px', borderRadius: '10px',
                            backgroundColor: isSimplified ? '#16a34a' : '#e5e5e5',
                            position: 'relative', cursor: 'pointer', transition: 'all 0.2s'
                        }} onClick={() => toggleSimplify(groupId)}>
                            <div style={{
                                width: '16px', height: '16px', borderRadius: '50%', backgroundColor: '#fff',
                                position: 'absolute', top: '2px', left: isSimplified ? '18px' : '2px',
                                transition: 'all 0.2s', boxShadow: '0 1px 2px rgba(0,0,0,0.2)'
                            }} />
                        </div>
                        <span style={{ fontSize: '14px', fontWeight: '500', color: '#525252' }}>Simplify debts</span>
                    </div>
                </div>
            )
            }

            {/* Pending Confirmations - Priority Alert */}
            {/* Pending Confirmations - Priority Alert */}
            {
                pendingConfirmations.length > 0 && (
                    <motion.div
                        initial={{ opacity: 0, y: -10 }}
                        animate={{ opacity: 1, y: 0 }}
                        style={{
                            padding: '16px',
                            borderRadius: '16px',
                            backgroundColor: '#fef9c3',
                            border: '2px solid #fde047'
                        }}
                    >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' }}>
                            <AlertCircle size={20} style={{ color: '#ca8a04' }} />
                            <p style={{ margin: 0, fontWeight: '700', fontSize: '15px', color: '#854d0e' }}>
                                {pendingConfirmations.length} Payment{pendingConfirmations.length > 1 ? 's' : ''} Awaiting Confirmation
                            </p>
                        </div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                            {pendingConfirmations.map((s) => (
                                <div
                                    key={s._id}
                                    style={{
                                        padding: '14px',
                                        backgroundColor: '#fff',
                                        borderRadius: '12px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '12px'
                                    }}
                                >
                                    <Avatar name={s.from.name} size="sm" />
                                    <div style={{ flex: 1 }}>
                                        <p style={{ margin: 0, fontSize: '14px', fontWeight: '600' }}>
                                            {s.from.name} paid you
                                        </p>
                                        <p style={{ margin: '2px 0 0', fontSize: '12px', color: '#737373' }}>
                                            {formatDate(s.createdAt, 'short')}
                                        </p>
                                    </div>
                                    <p style={{ margin: 0, fontSize: '18px', fontWeight: '800', color: '#16a34a' }}>
                                        {formatCurrency(s.amount)}
                                    </p>
                                    <div style={{ display: 'flex', gap: '6px' }}>
                                        <motion.button
                                            whileHover={{ scale: 1.05 }}
                                            whileTap={{ scale: 0.95 }}
                                            onClick={() => handleReject(s._id)}
                                            style={{
                                                padding: '8px 12px',
                                                borderRadius: '8px',
                                                border: '2px solid #fecaca',
                                                backgroundColor: '#fff',
                                                color: '#dc2626',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            âœ•
                                        </motion.button>
                                        <motion.button
                                            whileHover={{ scale: 1.05 }}
                                            whileTap={{ scale: 0.95 }}
                                            onClick={() => handleConfirmPending(s._id)}
                                            style={{
                                                padding: '8px 16px',
                                                borderRadius: '8px',
                                                border: 'none',
                                                backgroundColor: '#16a34a',
                                                color: '#fff',
                                                fontSize: '13px',
                                                fontWeight: '600',
                                                cursor: 'pointer'
                                            }}
                                        >
                                            âœ“ Confirm
                                        </motion.button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </motion.div>
                )
            }

            {/* My Pending Payments */}
            {
                myPendingPayments.length > 0 && (
                    <div style={{
                        padding: '14px',
                        borderRadius: '12px',
                        backgroundColor: '#fef2f2',
                        border: '2px solid #fecaca'
                    }}>
                        <p style={{ margin: 0, fontSize: '13px', color: '#b91c1c', fontWeight: '500' }}>
                            â³ {myPendingPayments.length} payment{myPendingPayments.length > 1 ? 's' : ''} awaiting confirmation
                        </p>
                    </div>
                )
            }

            <AnimatePresence mode="wait">
                {activeTab === 'debts' && (
                    <motion.div
                        key="debts"
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}
                    >
                        {/* DETAILED VIEW - Show pairwise relationships */}
                        {!isSimplified && detailedDebts && detailedDebts.length > 0 ? (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{ padding: '12px 16px', backgroundColor: '#f5f5f5', borderRadius: '12px' }}>
                                    <p style={{ margin: 0, fontSize: '13px', color: '#737373', fontWeight: '500' }}>
                                        ðŸ’¡ <strong>Detailed View:</strong> See all debts between each pair of people
                                    </p>
                                </div>

                                {detailedDebts.map((pair, idx) => {
                                    const isUserInvolved = pair.personA._id === user._id || pair.personB._id === user._id;
                                    if (!isAdmin && !isUserInvolved) return null;

                                    const pairKey = `pair-${pair.personA._id}-${pair.personB._id}`;
                                    const isExpanded = expandedDebt === pairKey;

                                    return (
                                        <motion.div
                                            key={pairKey}
                                            layout
                                            style={{
                                                borderRadius: '16px',
                                                backgroundColor: '#fff',
                                                border: '1px solid #e5e5e5',
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.04)',
                                                overflow: 'hidden'
                                            }}
                                        >
                                            {/* Pair Header */}
                                            <div style={{ padding: '16px', backgroundColor: '#fafafa', borderBottom: '1px solid #e5e5e5' }}>
                                                <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '12px' }}>
                                                    <Avatar name={pair.personA.name} size="sm" />
                                                    <ArrowRight size={16} color="#a3a3a3" />
                                                    <Avatar name={pair.personB.name} size="sm" />
                                                    <div style={{ flex: 1 }}>
                                                        <h4 style={{ margin: 0, fontSize: '15px', fontWeight: '600', color: '#0a0a0a' }}>
                                                            {pair.personA.name} â†” {pair.personB.name}
                                                        </h4>
                                                        <p style={{ margin: '2px 0 0', fontSize: '12px', color: '#737373' }}>
                                                            {pair.expenseCount} expense{pair.expenseCount !== 1 ? 's' : ''}
                                                        </p>
                                                    </div>
                                                </div>

                                                {/* Both Directions */}
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                                    {pair.aOwesB > 0.01 && (
                                                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '8px 12px', backgroundColor: '#fef2f2', borderRadius: '8px' }}>
                                                            <span style={{ fontSize: '13px', color: '#dc2626' }}>
                                                                {pair.personA.name} owes {pair.personB.name}
                                                            </span>
                                                            <span style={{ fontSize: '15px', fontWeight: '700', color: '#dc2626' }}>
                                                                {formatCurrency(pair.aOwesB)}
                                                            </span>
                                                        </div>
                                                    )}
                                                    {pair.bOwesA > 0.01 && (
                                                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '8px 12px', backgroundColor: '#f0fdf4', borderRadius: '8px' }}>
                                                            <span style={{ fontSize: '13px', color: '#16a34a' }}>
                                                                {pair.personB.name} owes {pair.personA.name}
                                                            </span>
                                                            <span style={{ fontSize: '15px', fontWeight: '700', color: '#16a34a' }}>
                                                                {formatCurrency(pair.bOwesA)}
                                                            </span>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Net Amount */}
                                                {pair.netAmount > 0.01 && (
                                                    <div style={{ marginTop: '12px', padding: '10px 12px', backgroundColor: '#fff', borderRadius: '8px', border: '2px solid #e5e5e5' }}>
                                                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                                            <span style={{ fontSize: '13px', fontWeight: '600', color: '#525252' }}>
                                                                Net: {pair.netDirection === 'AtoB' ? pair.personA.name : pair.personB.name} owes {pair.netDirection === 'AtoB' ? pair.personB.name : pair.personA.name}
                                                            </span>
                                                            <span style={{ fontSize: '16px', fontWeight: '800', color: '#0a0a0a' }}>
                                                                {formatCurrency(pair.netAmount)}
                                                            </span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            {/* Expense Details (Expandable) */}
                                            <div style={{ padding: '12px 16px' }}>
                                                <button
                                                    onClick={() => setExpandedDebt(isExpanded ? null : pairKey)}
                                                    style={{
                                                        width: '100%',
                                                        padding: '8px 12px',
                                                        backgroundColor: '#f5f5f5',
                                                        border: 'none',
                                                        borderRadius: '8px',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'space-between',
                                                        fontSize: '13px',
                                                        fontWeight: '600',
                                                        color: '#525252'
                                                    }}
                                                >
                                                    <span>ðŸ“‹ View {pair.expenseCount} expense{pair.expenseCount !== 1 ? 's' : ''}</span>
                                                    {isExpanded ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
                                                </button>

                                                <AnimatePresence>
                                                    {isExpanded && pair.expenses && (
                                                        <motion.div
                                                            initial={{ height: 0, opacity: 0 }}
                                                            animate={{ height: 'auto', opacity: 1 }}
                                                            exit={{ height: 0, opacity: 0 }}
                                                            style={{ overflow: 'hidden' }}
                                                        >
                                                            <div style={{ marginTop: '12px', display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                                                {pair.expenses.map((exp, i) => (
                                                                    <div
                                                                        key={`${exp.id}-${i}`}
                                                                        style={{
                                                                            padding: '10px 12px',
                                                                            backgroundColor: '#fafafa',
                                                                            borderRadius: '8px',
                                                                            fontSize: '12px'
                                                                        }}
                                                                    >
                                                                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                                                            <span style={{ fontWeight: '600', color: '#0a0a0a' }}>{exp.description}</span>
                                                                            <span style={{ fontWeight: '700', color: '#525252' }}>{formatCurrency(exp.amount)}</span>
                                                                        </div>
                                                                        <div style={{ display: 'flex', justifyContent: 'space-between', color: '#737373' }}>
                                                                            <span>Paid by {exp.paidBy}</span>
                                                                            <span>{formatDate(exp.date, 'short')}</span>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </motion.div>
                                                    )}
                                                </AnimatePresence>
                                            </div>

                                            {/* Action Buttons */}
                                            {isUserInvolved && pair.netAmount > 0.01 && (
                                                <div style={{ padding: '0 16px 16px' }}>
                                                    {((pair.netDirection === 'AtoB' && pair.personA._id === user._id) ||
                                                        (pair.netDirection === 'BtoA' && pair.personB._id === user._id)) ? (
                                                        <Button
                                                            onClick={() => {
                                                                const debt = {
                                                                    from: pair.netDirection === 'AtoB' ? pair.personA : pair.personB,
                                                                    to: pair.netDirection === 'AtoB' ? pair.personB : pair.personA,
                                                                    amount: pair.netAmount
                                                                };
                                                                handleMarkAsPaid(debt);
                                                            }}
                                                            style={{ width: '100%' }}
                                                        >
                                                            <Send size={16} /> Pay {formatCurrency(pair.netAmount)}
                                                        </Button>
                                                    ) : (
                                                        <Button
                                                            variant="secondary"
                                                            onClick={() => {
                                                                const debt = {
                                                                    from: pair.netDirection === 'AtoB' ? pair.personA : pair.personB,
                                                                    to: pair.netDirection === 'AtoB' ? pair.personB : pair.personA,
                                                                    amount: pair.netAmount
                                                                };
                                                                handleQuickConfirm(debt);
                                                            }}
                                                            style={{ width: '100%' }}
                                                        >
                                                            <Check size={16} /> Mark Received
                                                        </Button>
                                                    )}
                                                </div>
                                            )}
                                        </motion.div>
                                    );
                                })}
                            </div>
                        ) : isSimplified && detailedDebts && detailedDebts.length > 0 ? (
                            /* SIMPLIFIED VIEW - Show net amounts in same card design */
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                <div style={{ padding: '12px 16px', backgroundColor: '#f0fdf4', borderRadius: '12px', border: '1px solid #bbf7d0' }}>
                                    <p style={{ margin: 0, fontSize: '13px', color: '#16a34a', fontWeight: '500' }}>
                                        âœ¨ <strong>Simplified View:</strong> Showing net amounts between each pair
                                    </p>
                                </div>

                                {detailedDebts.map((pair, idx) => {
                                    // Only show pairs with net debt
                                    if (pair.netAmount <= 0.01) return null;

                                    const isUserInvolved = pair.personA._id === user._id || pair.personB._id === user._id;
                                    if (!isAdmin && !isUserInvolved) return null;

                                    const pairKey = `pair-simplified-${pair.personA._id}-${pair.personB._id}`;
                                    const isExpanded = expandedDebt === pairKey;

                                    const debtor = pair.netDirection === 'AtoB' ? pair.personA : pair.personB;
                                    const creditor = pair.netDirection === 'AtoB' ? pair.personB : pair.personA;
                                    const isUserDebtor = debtor._id === user._id;

                                    return (
                                        <motion.div
                                            key={pairKey}
                                            layout
                                            style={{
                                                borderRadius: '16px',
                                                backgroundColor: '#fff',
                                                border: `1px solid ${isUserDebtor ? '#fecaca' : '#bbf7d0'}`,
                                                boxShadow: '0 2px 8px rgba(0,0,0,0.04)',
                                                overflow: 'hidden'
                                            }}
                                        >
                                            {/* Main Row */}
                                            <div style={{ padding: '16px', display: 'flex', alignItems: 'center', gap: '16px' }}>
                                                <Avatar name={isUserDebtor ? creditor.name : debtor.name} size="md" />

                                                <div style={{ flex: 1 }}>
                                                    <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px' }}>
                                                        <h4 style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: '#0a0a0a' }}>
                                                            {isUserDebtor ? creditor.name : debtor.name}
                                                        </h4>
                                                    </div>
                                                    <p style={{ margin: '4px 0 0', fontSize: '13px', color: isUserDebtor ? '#dc2626' : '#16a34a', fontWeight: '500' }}>
                                                        {isUserDebtor ? 'you owe' : 'owes you'}
                                                    </p>
                                                </div>

                                                <div style={{ textAlign: 'right' }}>
                                                    <p style={{ margin: 0, fontSize: '18px', fontWeight: '800', color: isUserDebtor ? '#dc2626' : '#16a34a' }}>
                                                        {formatCurrency(pair.netAmount)}
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Action Bar */}
                                            <div style={{ padding: '0 16px 16px', display: 'flex', gap: '8px' }}>
                                                {isUserDebtor ? (
                                                    <motion.button
                                                        whileTap={{ scale: 0.98 }}
                                                        onClick={() => toggleExpand(pairKey)}
                                                        style={{
                                                            flex: 1, padding: '10px', borderRadius: '10px',
                                                            backgroundColor: '#dc2626', color: '#fff', border: 'none',
                                                            fontSize: '14px', fontWeight: '600', cursor: 'pointer',
                                                            display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'
                                                        }}
                                                    >
                                                        {isExpanded ? <ChevronUp size={16} /> : <Send size={16} />}
                                                        {isExpanded ? 'Cancel' : 'Pay'}
                                                    </motion.button>
                                                ) : (
                                                    <>
                                                        <motion.button
                                                            whileTap={{ scale: 0.98 }}
                                                            onClick={() => {
                                                                const debt = { from: debtor, to: creditor, amount: pair.netAmount };
                                                                handleQuickConfirm(debt);
                                                            }}
                                                            style={{
                                                                flex: 1, padding: '10px', borderRadius: '10px',
                                                                backgroundColor: '#16a34a', color: '#fff', border: 'none',
                                                                fontSize: '14px', fontWeight: '600', cursor: 'pointer',
                                                                display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'
                                                            }}
                                                        >
                                                            <Check size={16} /> Mark Received
                                                        </motion.button>
                                                        <motion.button
                                                            whileTap={{ scale: 0.98 }}
                                                            onClick={() => {
                                                                const { sendNudge, connect, isConnected } = useChatStore.getState();
                                                                if (!isConnected) connect();
                                                                sendNudge(groupId, debtor._id, user.name);
                                                                toast.success('ðŸ‘‹ Nudged!', `Reminded ${debtor.name}`);
                                                            }}
                                                            style={{
                                                                padding: '10px 14px', borderRadius: '10px',
                                                                backgroundColor: '#fef9c3', color: '#a16207', border: '1px solid #fde047',
                                                                fontSize: '14px', fontWeight: '600', cursor: 'pointer'
                                                            }}
                                                        >
                                                            ðŸ‘‹
                                                        </motion.button>
                                                    </>
                                                )}
                                            </div>

                                            {/* Expanded Payment Form */}
                                            <AnimatePresence>
                                                {isExpanded && isUserDebtor && (
                                                    <motion.div
                                                        initial={{ height: 0, opacity: 0 }}
                                                        animate={{ height: 'auto', opacity: 1 }}
                                                        exit={{ height: 0, opacity: 0 }}
                                                        style={{ overflow: 'hidden', borderTop: '1px solid #fecaca' }}
                                                    >
                                                        <div style={{ padding: '16px', backgroundColor: '#fef2f2', display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                                                <input
                                                                    type="checkbox"
                                                                    checked={isPartial}
                                                                    onChange={(e) => setIsPartial(e.target.checked)}
                                                                    style={{ width: '18px', height: '18px', cursor: 'pointer' }}
                                                                />
                                                                <label style={{ fontSize: '14px', color: '#525252', cursor: 'pointer' }} onClick={() => setIsPartial(!isPartial)}>
                                                                    Partial payment
                                                                </label>
                                                            </div>
                                                            {isPartial && (
                                                                <div style={{ position: 'relative' }}>
                                                                    <DollarSign size={18} style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', color: '#a3a3a3' }} />
                                                                    <input
                                                                        type="number"
                                                                        placeholder="Amount"
                                                                        value={paymentAmount}
                                                                        onChange={(e) => setPaymentAmount(e.target.value)}
                                                                        style={{ width: '100%', padding: '12px 12px 12px 36px', borderRadius: '10px', border: '1px solid #d4d4d4', outline: 'none' }}
                                                                    />
                                                                </div>
                                                            )}
                                                            <div style={{ position: 'relative' }}>
                                                                <FileText size={18} style={{ position: 'absolute', left: '12px', top: '14px', color: '#a3a3a3' }} />
                                                                <input
                                                                    type="text"
                                                                    placeholder="Add a note (optional)"
                                                                    value={note}
                                                                    onChange={(e) => setNote(e.target.value)}
                                                                    style={{ width: '100%', padding: '12px 12px 12px 36px', borderRadius: '10px', border: '1px solid #d4d4d4', outline: 'none' }}
                                                                />
                                                            </div>
                                                            <Button
                                                                onClick={() => {
                                                                    const debt = { from: debtor, to: creditor, amount: pair.netAmount };
                                                                    handleMarkAsPaid(debt);
                                                                }}
                                                                disabled={isPartial && !paymentAmount}
                                                            >
                                                                Pay
                                                            </Button>
                                                        </div>
                                                    </motion.div>
                                                )}
                                            </AnimatePresence>
                                        </motion.div>
                                    );
                                })}

                                {/* All Settled */}
                                {detailedDebts.filter(d => d.netAmount > 0.01).length === 0 && (
                                    <div style={{ textAlign: 'center', padding: '60px 24px', backgroundColor: '#f8fafc', borderRadius: '24px', border: '2px dashed #e2e8f0', marginTop: '20px' }}>
                                        <div style={{ width: '80px', height: '80px', borderRadius: '40px', backgroundColor: '#dcfce7', color: '#16a34a', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 20px' }}>
                                            <CheckCircle size={40} />
                                        </div>
                                        <h3 style={{ margin: '0 0 8px', fontSize: '20px', fontWeight: '700', color: '#0f172a' }}>All Settled Up!</h3>
                                        <p style={{ margin: 0, fontSize: '15px', color: '#64748b' }}>Everyone is square. No pending payments.</p>
                                    </div>
                                )}
                            </div>
                        ) : (
                            /* NO DEBTS */
                            <div style={{ textAlign: 'center', padding: '60px 24px', backgroundColor: '#f8fafc', borderRadius: '24px', border: '2px dashed #e2e8f0', marginTop: '20px' }}>
                                <div style={{ width: '80px', height: '80px', borderRadius: '40px', backgroundColor: '#dcfce7', color: '#16a34a', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 20px' }}>
                                    <CheckCircle size={40} />
                                </div>
                                <h3 style={{ margin: '0 0 8px', fontSize: '20px', fontWeight: '700', color: '#0f172a' }}>All Settled Up!</h3>
                                <p style={{ margin: 0, fontSize: '15px', color: '#64748b' }}>Everyone is square. No pending payments.</p>
                            </div>
                        )}
                    </motion.div>
                )}

                {activeTab === 'history' && (
                        const isExpanded = expandedDebt === debt.key;

                // Color Constants
                const theme = debt.type === 'owe'
                ? {bg: '#fef2f2', border: '#fecaca', text: '#dc2626', btn: '#dc2626' }
                : {bg: '#f0fdf4', border: '#bbf7d0', text: '#16a34a', btn: '#16a34a' };

                return (
                <motion.div
                    key={debt.key}
                    layout
                    style={{
                        borderRadius: '16px',
                        backgroundColor: '#fff',
                        border: `1px solid ${theme.border}`,
                        boxShadow: '0 2px 8px rgba(0,0,0,0.04)',
                        overflow: 'hidden'
                    }}
                >
                    {/* Main Row */}
                    <div style={{ padding: '16px', display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <Avatar name={otherUser.name} size="md" />

                        <div style={{ flex: 1 }}>
                            <div style={{ display: 'flex', alignItems: 'baseline', gap: '8px' }}>
                                <h4 style={{ margin: 0, fontSize: '16px', fontWeight: '600', color: '#0a0a0a' }}>
                                    {otherUser.name}
                                </h4>
                            </div>
                            <p style={{ margin: '4px 0 0', fontSize: '13px', color: theme.text, fontWeight: '500' }}>
                                {debt.type === 'owe' ? 'you owe' : 'owes you'}
                            </p>
                        </div>

                        <div style={{ textAlign: 'right' }}>
                            <p style={{ margin: 0, fontSize: '18px', fontWeight: '800', color: theme.text }}>
                                {formatCurrency(debt.amount)}
                            </p>
                        </div>
                    </div>

                    {/* Action Bar */}
                    <div style={{ padding: '0 16px 16px', display: 'flex', gap: '8px' }}>
                        {debt.type === 'owe' ? (
                            <motion.button
                                whileTap={{ scale: 0.98 }}
                                onClick={() => toggleExpand(debt.key)}
                                style={{
                                    flex: 1, padding: '10px', borderRadius: '10px',
                                    backgroundColor: theme.btn, color: '#fff', border: 'none',
                                    fontSize: '14px', fontWeight: '600', cursor: 'pointer',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'
                                }}
                            >
                                {isExpanded ? <ChevronUp size={16} /> : <Send size={16} />}
                                {isExpanded ? 'Cancel' : 'Pay'}
                            </motion.button>
                        ) : (
                            <>
                                <motion.button
                                    whileTap={{ scale: 0.98 }}
                                    onClick={() => handleQuickConfirm(debt)}
                                    style={{
                                        flex: 1, padding: '10px', borderRadius: '10px',
                                        backgroundColor: theme.btn, color: '#fff', border: 'none',
                                        fontSize: '14px', fontWeight: '600', cursor: 'pointer',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'
                                    }}
                                >
                                    <Check size={16} /> Mark Received
                                </motion.button>
                                <motion.button
                                    whileTap={{ scale: 0.98 }}
                                    onClick={() => {
                                        const { sendNudge, connect, isConnected } = useChatStore.getState();
                                        if (!isConnected) connect();
                                        sendNudge(groupId, debt.from._id, user.name);
                                        toast.success('ðŸ‘‹ Nudged!', `Reminded ${debt.from.name}`);
                                    }}
                                    style={{
                                        padding: '10px 14px', borderRadius: '10px',
                                        backgroundColor: '#fef9c3', color: '#a16207', border: '1px solid #fde047',
                                        fontSize: '14px', fontWeight: '600', cursor: 'pointer'
                                    }}
                                >
                                    ðŸ‘‹
                                </motion.button>
                            </>
                        )}
                    </div>

                    {/* Expanded Section (Payment Logic) same as before but inside this structure */}
                    <AnimatePresence>
                        {isExpanded && debt.type === 'owe' && (
                            <motion.div
                                initial={{ height: 0, opacity: 0 }}
                                animate={{ height: 'auto', opacity: 1 }}
                                exit={{ height: 0, opacity: 0 }}
                                style={{ borderTop: '1px solid #f0f0f0', backgroundColor: '#f9f9f9' }}
                            >
                                <div style={{ padding: '16px' }}>
                                    <div style={{ display: 'flex', gap: '8px', marginBottom: '16px' }}>
                                        <motion.button
                                            whileTap={{ scale: 0.98 }}
                                            onClick={() => handleMarkAsPaid(debt)}
                                            disabled={isLoading}
                                            style={{
                                                flex: 1, padding: '12px', borderRadius: '10px',
                                                border: '1px solid #e5e5e5', backgroundColor: '#fff',
                                                color: '#0a0a0a', fontSize: '14px', fontWeight: '600', cursor: 'pointer',
                                                boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
                                            }}
                                        >
                                            Pay Full {formatCurrency(debt.amount)}
                                        </motion.button>
                                    </div>

                                    <button
                                        onClick={() => setIsPartial(!isPartial)}
                                        style={{ width: '100%', padding: '0', background: 'none', border: 'none', fontSize: '13px', color: '#737373', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '4px', marginBottom: isPartial ? '12px' : '0' }}
                                    >
                                        {isPartial ? 'Enter custom amount' : 'Or pay partial amount'}
                                    </button>

                                    {isPartial && (
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <div style={{ flex: 1, position: 'relative' }}>
                                                <span style={{ position: 'absolute', left: '12px', top: '50%', transform: 'translateY(-50%)', fontWeight: '600', color: '#737373' }}>â‚¹</span>
                                                <input
                                                    type="number" value={paymentAmount} onChange={e => setPaymentAmount(e.target.value)}
                                                    placeholder="0.00"
                                                    style={{ width: '100%', padding: '12px 12px 12px 28px', borderRadius: '10px', border: '1px solid #d4d4d4', outline: 'none' }}
                                                />
                                            </div>
                                            <Button onClick={() => handleMarkAsPaid(debt)} disabled={!paymentAmount}>Pay</Button>
                                        </div>
                                    )}
                                </div>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </motion.div>
                );
                                })}

                {/* Admin View */}
                {isAdmin && otherDebts.length > 0 && (
                    <div style={{ marginTop: '12px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' }}>
                            <div style={{ height: '1px', flex: 1, backgroundColor: '#e5e5e5' }} />
                            <span style={{ fontSize: '12px', fontWeight: '600', color: '#a3a3a3', textTransform: 'uppercase' }}>Admin: Other Debts</span>
                            <div style={{ height: '1px', flex: 1, backgroundColor: '#e5e5e5' }} />
                        </div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {otherDebts.map((debt, i) => (
                                <div key={i} style={{ padding: '12px', borderRadius: '12px', backgroundColor: '#f9f9f9', border: '1px solid #e5e5e5', display: 'flex', alignItems: 'center', gap: '12px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '-8px' }}>
                                        <Avatar name={debt.from.name} size="xs" />
                                        <div style={{ width: '16px', height: '16px', borderRadius: '50%', backgroundColor: '#fff', border: '1px solid #e5e5e5', display: 'flex', alignItems: 'center', justifyContent: 'center', marginLeft: '-4px', marginRight: '-4px', zIndex: 1 }}>
                                            <ArrowRight size={10} color="#a3a3a3" />
                                        </div>
                                        <Avatar name={debt.to.name} size="xs" />
                                    </div>
                                    <span style={{ flex: 1, fontSize: '13px', color: '#525252' }}>{debt.from.name} owes {debt.to.name}</span>
                                    <span style={{ fontSize: '13px', fontWeight: '700', color: '#171717' }}>{formatCurrency(debt.amount)}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                )}



                {/* Switch back to Detailed View */}
                <div style={{ padding: '16px', backgroundColor: '#f5f5f5', borderRadius: '12px' }}>
                    <p style={{ margin: '0 0 8px', fontSize: '14px', fontWeight: '600', color: '#525252' }}>
                        Want to see individual debts?
                    </p>
                    <Button
                        variant="secondary"
                        onClick={() => toggleSimplify(groupId)}
                        style={{ width: '100%' }}
                    >
                        Switch to Detailed View
                    </Button>
                </div>
        </div>
    ) : (
        /* NO DEBTS */
        <div style={{ textAlign: 'center', padding: '60px 24px', backgroundColor: '#f8fafc', borderRadius: '24px', border: '2px dashed #e2e8f0', marginTop: '20px' }}>
            <div style={{ width: '80px', height: '80px', borderRadius: '40px', backgroundColor: '#dcfce7', color: '#16a34a', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 20px' }}>
                <CheckCircle size={40} />
            </div>
            <h3 style={{ margin: '0 0 8px', fontSize: '20px', fontWeight: '700', color: '#0f172a' }}>All Settled Up!</h3>
            <p style={{ margin: 0, fontSize: '15px', color: '#64748b' }}>Everyone is square. No pending payments.</p>
        </div>
    )
}
            </motion.div >
                )}

{
    activeTab === 'history' && (
        <motion.div
            key="history"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}
        >
            {settlements.length === 0 ? (
                <div style={{
                    textAlign: 'center',
                    padding: '40px',
                    color: '#737373'
                }}>
                    <Clock size={40} style={{ marginBottom: '12px', opacity: 0.5 }} />
                    <p style={{ margin: 0, fontSize: '15px' }}>No settlement history yet</p>
                </div>
            ) : (
                settlements.map((s) => (
                    <div
                        key={s._id}
                        style={{
                            padding: '14px',
                            borderRadius: '12px',
                            backgroundColor: s.confirmedByRecipient ? '#f0fdf4' : '#fefce8',
                            border: '2px solid',
                            borderColor: s.confirmedByRecipient ? '#bbf7d0' : '#fde68a',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '12px'
                        }}
                    >
                        <Avatar name={s.from.name} size="sm" />
                        <ArrowRight size={14} style={{ color: '#a3a3a3' }} />
                        <Avatar name={s.to.name} size="sm" />
                        <div style={{ flex: 1 }}>
                            <p style={{ margin: 0, fontSize: '14px', fontWeight: '500' }}>
                                {s.from.name} â†’ {s.to.name}
                            </p>
                            <p style={{ margin: '2px 0 0', fontSize: '12px', color: '#737373' }}>
                                {formatDate(s.createdAt, 'short')}
                            </p>
                        </div>
                        <div style={{ textAlign: 'right' }}>
                            <p style={{
                                margin: 0,
                                fontSize: '16px',
                                fontWeight: '700',
                                color: s.confirmedByRecipient ? '#16a34a' : '#ca8a04'
                            }}>
                                {formatCurrency(s.amount)}
                            </p>
                            <Badge
                                size="sm"
                                variant={s.confirmedByRecipient ? 'success' : 'warning'}
                            >
                                {s.confirmedByRecipient ? 'Complete' : 'Pending'}
                            </Badge>
                        </div>
                    </div>
                ))
            )}
        </motion.div>
    )
}
        </AnimatePresence >
        </div >
    );
}

export default SettleUp;
